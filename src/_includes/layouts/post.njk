{% extends "layouts/base.njk" %}

{# Get first tag safely #}
{% set firstTag = null %}
{% if tags and tags.length %}
  {% set firstTag = tags[0] %}
{% endif %}

{% block content %}
<article class="aa-post">
  <div class="container">

    <a href="/adventures/" class="aa-post__back">‚Üê Back to Adventures</a>

    {% if cover %}
      <img class="aa-post__cover" src="{{ cover }}" alt="">
    {% endif %}

    <h1 class="aa-post__title">{{ title }}</h1>

    {% if excerpt %}
      <p class="aa-post__subtitle">{{ excerpt }}</p>
    {% endif %}

    <div class="aa-post__meta">
      {% if firstTag %}
        <span class="aa-pill">{{ firstTag }}</span>
      {% endif %}
      <span class="aa-post__meta-chip">üìÖ {{ page.date | date("dd/MM/yyyy") }}</span>
      <span class="aa-post__meta-chip">‚è±Ô∏è {{ content | readTime }}</span>
    </div>

    <!-- Main content -->
    <div class="aa-post__card content">
      {{ content | safe }}
    </div>

    <!-- Share row -->
    <div class="aa-post__share" style="display:flex;gap:.6rem;align-items:center;margin-top:1rem;flex-wrap:wrap">
      <span class="aa-post__share-label" style="font-weight:700;opacity:.8">Share this adventure:</span>
      {% set shareUrl = page.url %}
      {% set shareText = title or "Archie‚Äôs Adventures" %}
      <a class="aa-share" href="https://twitter.com/intent/tweet?url={{ shareUrl | urlencode }}&text={{ shareText | urlencode }}" target="_blank" rel="noopener">X</a>
      <a class="aa-share" href="https://www.facebook.com/sharer/sharer.php?u={{ shareUrl | urlencode }}" target="_blank" rel="noopener">Facebook</a>
      <button class="aa-share aa-share--copy" data-copy="{{ shareUrl }}" type="button">Copy link</button>
    </div>

    <!-- Related adventures (same first tag, up to 3) -->
    {% if firstTag %}
      {% set shown = 0 %}
      {% set opened = false %}
      {% for p in collections.posts | reverse %}
        {% if p.url != page.url and p.data.tags and (firstTag in p.data.tags) and shown < 3 %}
          {% if opened == false %}
            {% set opened = true %}
            <section class="aa-related" style="margin-top:2rem">
              <h2>More in {{ firstTag }}</h2>
              <div class="aa-grid">
          {% endif %}

          {# ---- Inline card (no include) ---- #}
          {% set cover2    = p.data.cover or '/images/sample.jpg' %}
          {% set tagsList2 = p.data.tags or [] %}
          {% set firstTag2 = '' %}
          {% if tagsList2 | length %}
            {% set firstTag2 = tagsList2[0] %}
          {% endif %}

          <a class="aa-card" href="{{ p.url }}">
            <div class="aa-card__media">
              <img src="{{ cover2 }}" alt="">
            </div>
            <div class="aa-card__body">
              <div class="aa-card__toprow">
                {% if firstTag2 %}<span class="aa-pill">{{ firstTag2 }}</span>{% endif %}
                <span class="aa-meta">{{ p.templateContent | readTime }}</span>
              </div>
              <h3 class="aa-card__title">{{ p.data.title }}</h3>
              {% if p.data.excerpt %}
                <p class="aa-card__excerpt">{{ p.data.excerpt }}</p>
              {% endif %}
              <div class="aa-card__meta">
                <span class="aa-meta">{{ p.date | date("dd/MM/yyyy") }}</span>
              </div>
            </div>
          </a>
          {# ---- /Inline card ---- #}

          {% set shown = shown + 1 %}
        {% endif %}
      {% endfor %}
      {% if opened %}
            </div>
          </section>
      {% endif %}
    {% endif %}

    <!-- Bottom CTA -->
    <div class="aa-post__footer">
      <img src="/images/logo-badge.svg" alt="" class="aa-post__mini" width="28" height="28">
      <p>Thanks for joining my adventure! ‚ú®</p>
      <a class="btn-2tone" href="/adventures/">Discover More Adventures</a>
    </div>

  </div>
</article>

<script>
  (function(){
    const btn = document.querySelector('.aa-share--copy');
    if(!btn) return;
    btn.addEventListener('click', async () => {
      try {
        const rel = btn.dataset.copy || window.location.pathname;
        const abs = new URL(rel, window.location.origin).toString();
        await navigator.clipboard.writeText(abs);
        btn.textContent = 'Copied!';
        setTimeout(()=>btn.textContent='Copy link', 1400);
      } catch(e) {
        btn.textContent = 'Failed';
      }
    });
  })();
</script>
{% endblock %}
