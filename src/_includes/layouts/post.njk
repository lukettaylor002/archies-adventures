{% extends "layouts/base.njk" %}

{# firstTag: Nunjucks-safe way (no ternary) #}
{% set firstTag = null %}
{% if tags and tags.length %}
  {% set firstTag = tags[0] %}
{% endif %}

{% block content %}
<article class="aa-post">
  <div class="container">

    <a href="/adventures/" class="aa-post__back">‚Üê Back to Adventures</a>

    {% if cover %}
      <img class="aa-post__cover" src="{{ cover }}" alt="">
    {% endif %}

    <h1 class="aa-post__title">{{ title }}</h1>

    {% if excerpt %}
      <p class="aa-post__subtitle">{{ excerpt }}</p>
    {% endif %}

    <div class="aa-post__meta">
      {% if firstTag %}
        <span class="aa-pill">{{ firstTag }}</span>
      {% endif %}

      <span class="aa-post__meta-chip">
        <span aria-hidden="true">üìÖ</span>
        {{ page.date | date("dd/MM/yyyy") }}
      </span>

      <span class="aa-post__meta-chip">
        <span aria-hidden="true">‚è±Ô∏è</span>
        {{ content | readTime }}
      </span>
    </div>

    <!-- Main content -->
    <div class="aa-post__card content">
      {{ content | safe }}
    </div>

    <!-- Share row -->
    <div class="aa-post__share">
      <span class="aa-post__share-label">Share this adventure:</span>
      {% set shareUrl = page.url %}
      {% set shareText = title or "Archie‚Äôs Adventures" %}
      <a class="aa-share" href="https://twitter.com/intent/tweet?url={{ shareUrl | urlencode }}&text={{ shareText | urlencode }}" target="_blank" rel="noopener">X</a>
      <a class="aa-share" href="https://www.facebook.com/sharer/sharer.php?u={{ shareUrl | urlencode }}" target="_blank" rel="noopener">Facebook</a>
      <button class="aa-share aa-share--copy" data-copy="{{ shareUrl }}">Copy link</button>
    </div>

    <!-- Related adventures: same first tag, max 3 -->
    {% if firstTag %}
      {% set shown = 0 %}
      {% set opened = false %}
      {% for p in collections.posts | reverse %}
        {% if p.url != page.url
              and p.data.tags
              and (firstTag in p.data.tags)
              and shown < 3 %}
          {% if opened == false %}
            {% set opened = true %}
            <section class="aa-related">
              <h2>More in {{ firstTag }}</h2>
              <div class="aa-grid">
          {% endif %}

          {% include "partials/card.njk" post=p %}
          {% set shown = shown + 1 %}
        {% endif %}
      {% endfor %}
      {% if opened %}
              </div>
            </section>
      {% endif %}
    {% endif %}

    <!-- Bottom CTA -->
    <div class="aa-post__footer">
      <img src="/images/logo-badge.svg" alt="" class="aa-post__mini" width="28" height="28">
      <p>Thanks for joining my adventure! ‚ú®</p>
      <a class="btn-2tone" href="/adventures/">Discover More Adventures</a>
    </div>

  </div>
</article>

<script>
  (function(){
    const btn = document.querySelector('.aa-share--copy');
    if(!btn) return;
    btn.addEventListener('click', async () => {
      try {
        const url = new URL(btn.dataset.copy, window.location.origin).toString();
        await navigator.clipboard.writeText(url);
        btn.textContent = 'Copied!';
        setTimeout(()=>btn.textContent='Copy link', 1500);
      } catch(e) { btn.textContent = 'Failed'; }
    });
  })();
</script>
{% endblock %}
