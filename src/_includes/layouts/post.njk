{% extends "layouts/base.njk" %}
{% set firstTag = (tags and tags.length) ? tags[0] : null %}

{% block content %}
<article class="aa-post">
  <div class="container">

    <a href="/adventures/" class="aa-post__back">‚Üê Back to Adventures</a>

    {% if cover %}
      <img class="aa-post__cover" src="{{ cover }}" alt="">
    {% endif %}

    <h1 class="aa-post__title">{{ title }}</h1>

    {% if excerpt %}
      <p class="aa-post__subtitle">{{ excerpt }}</p>
    {% endif %}

    <div class="aa-post__meta">
      {% if firstTag %}
        <span class="chip chip--green">{{ firstTag }}</span>
      {% endif %}

      <span class="aa-post__meta-chip">
        <span aria-hidden="true">üìÖ</span>
        {{ page.date | date("dd/MM/yyyy") }}
      </span>

      <span class="aa-post__meta-chip">
        <span aria-hidden="true">‚è±Ô∏è</span>
        {{ content | readTime }}
      </span>
    </div>

    <!-- Content card -->
    <div class="aa-post__card content">
      {{ content | safe }}
    </div>

    <!-- Share row -->
    <div class="aa-post__share">
      <span class="aa-post__share-label">Share this adventure:</span>
      {% set shareUrl = site.url ~ page.url %}
      {% set shareText = (title or "Archie‚Äôs Adventures") %}
      <a class="aa-share" href="https://twitter.com/intent/tweet?url={{ shareUrl | urlencode }}&text={{ shareText | urlencode }}" target="_blank" rel="noopener">X</a>
      <a class="aa-share" href="https://www.facebook.com/sharer/sharer.php?u={{ shareUrl | urlencode }}" target="_blank" rel="noopener">Facebook</a>
      <button class="aa-share aa-share--copy" data-copy="{{ shareUrl }}">Copy link</button>
    </div>

    <!-- Related posts (same first tag) -->
    {% if firstTag %}
      {% set related = collections.posts
          | reverse
          | filter(post => post.url != page.url and (post.data.tags or []).includes(firstTag))
          | slice(0, 3) %}

      {% if related | length %}
        <section class="aa-related">
          <h2>More in {{ firstTag }}</h2>
          <div class="aa-grid">
            {% for p in related %}
              {# Reuse the card partial if you like; otherwise inline a small card #}
              {% include "partials/card.njk" post=p %}
            {% endfor %}
          </div>
        </section>
      {% endif %}
    {% endif %}

    <!-- Bottom thanks/CTA -->
    <div class="aa-post__footer">
      <img src="/images/logo-badge.svg" alt="" class="aa-post__mini" width="28" height="28">
      <p>Thanks for joining my adventure! ‚ú®</p>
      <a class="btn-2tone" href="/adventures/">Discover More Adventures</a>
    </div>

  </div>
</article>

<!-- Small helper to copy link -->
<script>
  (function(){
    const btn = document.querySelector('.aa-share--copy');
    if(!btn) return;
    btn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(btn.dataset.copy);
        btn.textContent = 'Copied!';
        setTimeout(()=>btn.textContent='Copy link', 1500);
      } catch(e) { btn.textContent = 'Failed'; }
    });
  })();
</script>

{# Basic JSON-LD for Article (optional but good for SEO) #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": {{ title | dump }},
  "description": {{ (excerpt or '') | dump }},
  "datePublished": "{{ page.date.toISOString() }}",
  {% if cover %}"image": ["{{ site.url }}{{ cover }}"],{% endif %}
  "url": "{{ site.url }}{{ page.url }}",
  "mainEntityOfPage": {"@type": "WebPage","@id": "{{ site.url }}{{ page.url }}"},
  "publisher": {"@type":"Organization","name":"Archie's Adventures","logo":{"@type":"ImageObject","url":"{{ site.url }}/images/logo-badge.svg"}}
}
</script>
{% endblock %}
